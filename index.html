<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Férias</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Paleta clara com azul marinho e verde */
      --bg:#f6f8fb; --panel:#ffffff; --muted:#5b6474; --text:#0b1b3b; --brand:#0b1b3b; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --border:#e4e7ee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:20}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#3b5aa6);display:grid;place-items:center;color:white;font-weight:800}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#f2f5fb;cursor:pointer;color:var(--text)}
    .tab.active{background:var(--brand);border-color:transparent;color:white}
    main{max-width:1100px;margin:18px auto;padding:0 16px 80px}
    .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(11,27,59,.08)}
    .card h3{margin:0 0 8px 0;font-size:18px}
    .card .head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card .body{padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text)}
    textarea{min-height:72px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .btn{padding:10px 14px;border:1px solid var(--border);background:#eef2fb;border-radius:12px;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--brand);border-color:transparent;color:white;font-weight:600}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .btn.warn{background:var(--warn);border-color:transparent;color:#fff}
    .btnline{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
    th{color:#2b375a;font-weight:600}
    tr:hover{background:#f5f7fc}
    .pill{padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid var(--border);display:inline-block}
    .pill.ok{background:rgba(22,163,74,.12);color:#0f5132}
    .pill.warn{background:rgba(245,158,11,.15);color:#7a4e00}
    .pill.danger{background:rgba(239,68,68,.12);color:#7f1d1d}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center}
    .hide{display:none}
    footer{position:fixed;bottom:10px;left:0;right:0}
    .bar{max-width:1100px;margin:0 auto;background:#ffffff;backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:16px;padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .box{padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .kpi .box b{display:block;font-size:18px}
    .search{flex:1}
    .print-only{display:none}
    @media (max-width: 940px){
      .grid{grid-template-columns:1fr}
      footer{position:static}
    }
    @media print{
      header, footer, .tabbar, .no-print{display:none !important}
      body{background:#fff;color:#000}
      .card{box-shadow:none;border:1px solid #ddd}
      .print-only{display:block}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">F</div>
        <div>
          <div style="font-weight:700">Controle de Férias</div>
          <div class="muted" style="font-size:12px">Colaboradores • Terceirizados • Prestadores</div>
        </div>
      </div>
      <nav class="tabbar">
        <button class="tab active" data-tab="funcionarios">Funcionários</button>
        <button class="tab" data-tab="ferias">Férias</button>
        <button class="tab" data-tab="relatorios">Relatórios</button>
        <button class="tab" data-tab="config">Configuração</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- FUNCIONÁRIOS -->
    <section id="funcionarios" class="grid">
      <div class="card">
        <div class="head"><h3 id="formFuncTitle">Adicionar Funcionário</h3></div>
        <div class="body">
          <form id="formFuncionario" autocomplete="off">
            <input type="hidden" id="f_id">
            <label>Nome</label>
            <input id="f_nome" required>
            <div class="row">
              <div>
                <label>Cargo/Função</label>
                <input id="f_cargo">
              </div>
              <div>
                <label>Tipo</label>
                <select id="f_tipo">
                  <option>CLT</option>
                  <option>Terceirizado</option>
                  <option>Prestador</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Data de Admissão</label>
                <input type="date" id="f_admissao">
              </div>
              <div>
                <label>Dias de direito/ano</label>
                <input type="number" id="f_dias_direito" value="30" min="0" max="60">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Período Aquisitivo (Início)</label>
                <input type="date" id="f_aquisitivo_ini">
              </div>
              <div>
                <label>Período Aquisitivo (Fim)</label>
                <input type="date" id="f_aquisitivo_fim">
              </div>
            </div>
            <label>Observações</label>
            <textarea id="f_obs"></textarea>
            <div class="btnline" style="margin-top:10px">
              <button class="btn primary" type="submit">Salvar</button>
              <button class="btn" type="reset" id="btnFuncionarioReset">Limpar</button>
              <button class="btn danger hide" type="button" id="btnFuncionarioCancelarEdicao">Cancelar edição</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h3>Lista de Funcionários</h3>
          <div class="right">
            <input class="search" id="buscaFuncionario" placeholder="Buscar por nome, cargo ou tipo...">
            <button class="btn" id="btnExportarFuncionarios" title="Exportar JSON">Exportar</button>
            <label class="btn ghost" for="importFuncFile">Importar</label>
            <input id="importFuncFile" type="file" accept="application/json" class="hide" />
          </div>
        </div>
        <div class="body">
          <table id="tFuncionarios">
            <thead>
              <tr>
                <th>Nome</th><th>Cargo</th><th>Tipo</th><th>Admissão</th><th>Dias/ano</th><th>Período Aquisitivo</th><th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- FÉRIAS -->
    <section id="ferias" class="grid hide">
      <div class="card">
        <div class="head"><h3 id="formFeriasTitle">Agendar/Registrar Férias</h3></div>
        <div class="body">
          <form id="formFerias" autocomplete="off">
            <input type="hidden" id="v_id">
            <div class="row">
              <div>
                <label>Funcionário</label>
                <select id="v_funcionario" required></select>
              </div>
              <div>
                <label>Status</label>
                <select id="v_status">
                  <option>Agendado</option>
                  <option>Gozado</option>
                  <option>Vencido</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Data de Programação</label>
                <input type="date" id="v_programacao">
              </div>
              <div>
                <label>Período Aquisitivo (ex: 2023-2024)</label>
                <input id="v_aquisitivo" placeholder="AAAA-AAAA">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Início das Férias</label>
                <input type="date" id="v_inicio">
              </div>
              <div>
                <label>Fim das Férias</label>
                <input type="date" id="v_fim">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Dias Gozados</label>
                <input type="number" id="v_dias" min="0" max="60" placeholder="Calcula automático pelas datas">
              </div>
              <div>
                <label>Vencimento (limite p/ concessão)</label>
                <input type="date" id="v_vencimento">
              </div>
            </div>
            <label>Observações</label>
            <textarea id="v_obs"></textarea>
            <div class="btnline" style="margin-top:10px">
              <button class="btn primary" type="submit">Salvar</button>
              <button class="btn" type="reset" id="btnFeriasReset">Limpar</button>
              <button class="btn danger hide" type="button" id="btnFeriasCancelarEdicao">Cancelar edição</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h3>Escala e Registros</h3>
          <div class="right">
            <input class="search" id="buscaFerias" placeholder="Buscar por nome ou período...">
            <select id="filtroStatus">
              <option value="">Todos os status</option>
              <option>Agendado</option>
              <option>Gozado</option>
              <option>Vencido</option>
            </select>
          </div>
        </div>
        <div class="body">
          <table id="tFerias">
            <thead>
              <tr>
                <th>Funcionário</th><th>Período</th><th>Programação</th><th>Início</th><th>Fim</th><th>Dias</th><th>Vencimento</th><th>Status</th><th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RELATÓRIOS -->
    <section id="relatorios" class="hide">
      <div class="card">
        <div class="head">
          <h3>Relatórios</h3>
          <div class="right no-print">
            <select id="r_func"></select>
            <select id="r_ano"></select>
            <select id="r_mes">
              <option value="">Mês (todos)</option>
            </select>
            <button class="btn" id="btnFiltrarRelatorio">Filtrar</button>
            <button class="btn" id="btnLimparRelatorio">Limpar</button>
            <button class="btn primary" id="btnImprimir">Imprimir</button>
          </div>
        </div>
        <div class="body">
          <div class="kpi print-only" id="tituloRelatorio"></div>
          <div class="kpi" id="kpis">
            <div class="box"><span class="muted">Registros no período</span><b id="kpiRegistros">0</b></div>
            <div class="box"><span class="muted">Dias gozados</span><b id="kpiDias">0</b></div>
            <div class="box"><span class="muted">Vencendo (≤30 dias)</span><b id="kpiVencendo">0</b></div>
            <div class="box"><span class="muted">Vencidos</span><b id="kpiVencidos">0</b></div>
          </div>
          <div style="margin-top:12px">
            <table id="tRelatorio">
              <thead>
                <tr>
                  <th>Funcionário</th><th>Tipo</th><th>Período Aquisitivo</th><th>Início</th><th>Fim</th><th>Dias</th><th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="config" class="hide">
      <div class="card">
        <div class="head"><h3>Configuração de Dados</h3></div>
        <div class="body">
          <p class="muted">Por padrão, os dados ficam salvos no seu navegador (localStorage). Opcionalmente, conecte a um projeto Firebase Firestore para sincronizar na nuvem (grátis no plano Spark).</p>
          <h4>Modo Local (padrão)</h4>
          <div class="btnline">
            <button class="btn" id="btnBackup">Baixar backup (.json)</button>
            <label class="btn ghost" for="restoreFile">Restaurar</label>
            <input id="restoreFile" type="file" accept="application/json" class="hide" />
            <button class="btn warn" id="btnZerarLocal">Zerar dados locais</button>
          </div>
          <hr style="border-color:var(--border);margin:18px 0">
          <h4>Modo Nuvem (Firebase opcional)</h4>
          <div class="row">
            <div>
              <label>firebaseConfig (JSON)</label>
              <textarea id="cfgFirebase" placeholder='{"apiKey":"...","authDomain":"...","projectId":"..."}'></textarea>
            </div>
            <div>
              <label>ID da Organização/Empresa (namespace)</label>
              <input id="cfgOrg" placeholder="ex.: minhaempresa">
              <label>Autenticação</label>
              <select id="cfgAuth">
                <option value="anon">Anônima</option>
                <option value="none">Sem auth (somente leitura pública das regras)</option>
              </select>
              <div class="btnline" style="margin-top:12px">
                <button class="btn" id="btnTestFirebase">Testar conexão</button>
                <button class="btn primary" id="btnAtivarFirebase">Ativar</button>
                <button class="btn warn" id="btnDesativarFirebase">Desativar</button>
              </div>
              <p class="muted" style="margin-top:8px">Após ativar, os dados passarão a ser salvos/consultados no Firestore. Use regras de segurança adequadas.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="no-print">
    <div class="bar">
      <div class="right" style="gap:14px">
        <div class="muted">Status do armazenamento:</div>
        <div id="storeStatus" class="pill ok">Local</div>
      </div>
      <div class="right">
        <small class="muted">Dica: use os filtros em Relatórios e clique em Imprimir para gerar PDF do mês/ano.</small>
      </div>
    </div>
  </footer>

  <!-- Firebase (opcional) -->
  <script type="module" id="firebaseLoader">
    // O carregamento real só acontecerá quando usuário ativar em Config.
  </script>

  <script>
  // ======== Utilidades ========
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const fmtDate = d => d ? new Date(d).toLocaleDateString('pt-BR',{timeZone:'UTC'}) : '';
  const parseDate = s => s ? new Date(s+'T00:00:00Z') : null;
  const diffDaysInclusive = (a,b) => {
    if(!a||!b) return 0; const ms = (parseDate(b)-parseDate(a));
    return Math.floor(ms/86400000)+1; // inclui fim-de-semana
  }
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const inNextDays = (dateStr, days=30) => {
    if(!dateStr) return false; const d=parseDate(dateStr), now=new Date(); now.setUTCHours(0,0,0,0);
    const diff=(d-now); return diff>=0 && diff<=days*86400000;
  }

  // ======== Camada de Dados (LocalStorage por padrão) ========
  const Storage = (()=>{
    const NS='ferias_app_v1';
    const load = () => JSON.parse(localStorage.getItem(NS) || '{"funcionarios":[],"ferias":[],"cfg":{}}');
    const save = (data) => localStorage.setItem(NS, JSON.stringify(data));
    let data = load();
    const api = {
      mode: ()=> 'local',
      getAll: (col)=> data[col] || [],
      setAll: (col, arr)=> { data[col]=arr; save(data); return arr; },
      push: (col, obj)=> { data[col].push(obj); save(data); return obj; },
      update: (col, id, patch)=> { const i=data[col].findIndex(x=>x.id===id); if(i>-1){ data[col][i]={...data[col][i],...patch}; save(data); return data[col][i]; } return null; },
      remove: (col, id)=> { data[col]=data[col].filter(x=>x.id!==id); save(data); },
      backup: ()=> JSON.stringify(data, null, 2),
      restore: (json)=> { data=JSON.parse(json); save(data); return data; },
      getCfg: ()=> data.cfg || {},
      setCfg: (cfg)=> { data.cfg=cfg; save(data); }
    };
    return api;
  })();

  // Firebase (ativado sob demanda)
  let Cloud = null; // substitui Storage quando ativado

  async function activateFirebase(cfgJson, org='default', authMode='anon'){
    const cfg = JSON.parse(cfgJson);
    const loader = document.createElement('script');
    loader.type='module';
    loader.textContent = `
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
      import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
      import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
      const app = initializeApp(${JSON.stringify(cfg)});
      const db = getFirestore(app);
      const auth = getAuth(app);
      const org = ${JSON.stringify(org)};
      ${authMode==='anon' ? 'await signInAnonymously(auth);' : ''}
      window.__db = db; window.__org = org;
      window.__fns = { collection, getDocs, setDoc, doc, deleteDoc };
    `;
    document.body.appendChild(loader);
    // aguarda carregar
    await new Promise(r=>setTimeout(r,800));

    Cloud = {
      mode: ()=> 'firebase',
      async getAll(col){
        const snap = await __fns.getDocs(__fns.collection(__db, `${__org}_${col}`));
        const arr=[]; snap.forEach(d=>arr.push(d.data())); return arr;
      },
      async setAll(col, arr){
        // sobrescreve: deleta todos e grava todos
        const cur = await this.getAll(col);
        const del = cur.map(o=> __fns.deleteDoc(__fns.doc(__db, `${__org}_${col}`, o.id)));
        await Promise.allSettled(del);
        const ops = arr.map(o=> __fns.setDoc(__fns.doc(__db, `${__org}_${col}`, o.id), o));
        await Promise.all(ops); return arr;
      },
      async push(col, obj){ await __fns.setDoc(__fns.doc(__db, `${__org}_${col}`, obj.id), obj); return obj; },
      async update(col, id, patch){ const all = await this.getAll(col); const obj = all.find(x=>x.id===id); if(!obj) return null; const merged={...obj,...patch}; await __fns.setDoc(__fns.doc(__db, `${__org}_${col}`, id), merged); return merged; },
      async remove(col, id){ await __fns.deleteDoc(__fns.doc(__db, `${__org}_${col}`, id)); },
      async backup(){ const funcionarios = await this.getAll('funcionarios'); const ferias = await this.getAll('ferias'); return JSON.stringify({funcionarios, ferias}, null, 2); },
      async restore(json){ const d=JSON.parse(json); await this.setAll('funcionarios', d.funcionarios||[]); await this.setAll('ferias', d.ferias||[]); return d; },
      getCfg(){ return { cloud:true, org } }, setCfg(cfg){}
    };

    $('#storeStatus').textContent='Firebase';
    $('#storeStatus').className='pill ok';
  }

  // API de dados dinâmica
  const DB = new Proxy({}, {
    get(_,prop){
      const target = Cloud || Storage;
      return target[prop];
    }
  });

  // ======== Estado/UI ========
  const state = { funcionarios: [], ferias: [] };

  async function loadAll(){
    state.funcionarios = await DB.getAll('funcionarios');
    state.ferias = await DB.getAll('ferias');
    renderFuncionarios();
    renderFerias();
    renderRelatoriosInit();
    fillFuncionariosSelect();
  }

  function renderFuncionarios(){
    const q = ($('#buscaFuncionario').value||'').toLowerCase();
    const tbody = $('#tFuncionarios tbody'); tbody.innerHTML='';
    state.funcionarios
      .filter(f => [f.nome,f.cargo,f.tipo].join(' ').toLowerCase().includes(q))
      .sort((a,b)=> a.nome.localeCompare(b.nome,'pt'))
      .forEach(f=>{
        const tr = document.createElement('tr');
        const per = f.aquisitivo_ini && f.aquisitivo_fim ? `${fmtDate(f.aquisitivo_ini)} – ${fmtDate(f.aquisitivo_fim)}` : '';
        tr.innerHTML = `
          <td>${f.nome||''}</td>
          <td>${f.cargo||''}</td>
          <td>${f.tipo||''}</td>
          <td>${fmtDate(f.admissao)||''}</td>
          <td>${f.dias_direito||''}</td>
          <td>${per}</td>
          <td>
            <button class="btn" onclick='editFuncionario("${f.id}")'>Editar</button>
            <button class="btn" onclick='reportFuncionario("${f.id}")'>Relatório</button>
            <button class="btn danger" onclick='delFuncionario("${f.id}")'>Excluir</button>
          </td>`;
        tbody.appendChild(tr);
      });
  }

  function fillFuncionariosSelect(){
    const sel = $('#v_funcionario'); sel.innerHTML='';
    state.funcionarios.sort((a,b)=>a.nome.localeCompare(b.nome,'pt')).forEach(f=>{
      const o=document.createElement('option'); o.value=f.id; o.textContent=f.nome; sel.appendChild(o);
    });
  }

  function renderFerias(){
    const q = ($('#buscaFerias').value||'').toLowerCase();
    const fs = $('#filtroStatus').value || '';
    const tbody = $('#tFerias tbody'); tbody.innerHTML='';
    state.ferias
      .map(v=> ({...v, funcionario: state.funcionarios.find(f=>f.id===v.funcionarioId)||{} }))
      .filter(v=> (v.funcionario.nome||'').toLowerCase().includes(q) || (v.aquisitivo||'').toLowerCase().includes(q))
      .filter(v=> !fs || v.status===fs)
      .sort((a,b)=> (a.inicio||'').localeCompare(b.inicio||''))
      .forEach(v=>{
        const tr = document.createElement('tr');
        let pillClass='ok', pillText='Dentro do prazo';
        if(v.vencimento){
          if(inNextDays(v.vencimento,30)) { pillClass='warn'; pillText='Vencendo'; }
          const hoje = new Date(); hoje.setUTCHours(0,0,0,0);
          if(parseDate(v.vencimento) < hoje) { pillClass='danger'; pillText='Vencido'; }
        }
        tr.innerHTML = `
          <td>${v.funcionario.nome||''}</td>
          <td>${v.aquisitivo||''}</td>
          <td>${fmtDate(v.programacao)||''}</td>
          <td>${fmtDate(v.inicio)||''}</td>
          <td>${fmtDate(v.fim)||''}</td>
          <td>${v.dias||''}</td>
          <td>${fmtDate(v.vencimento)||''} ${v.vencimento? `<span class="pill ${pillClass}">${pillText}</span>`:''}</td>
          <td>${v.status||''}</td>
          <td>
            <button class="btn" onclick='editFerias("${v.id}")'>Editar</button>
            <button class="btn danger" onclick='delFerias("${v.id}")'>Excluir</button>
          </td>`;
        tbody.appendChild(tr);
      });
  }

  function renderRelatoriosInit(){
    // popular funcionários
    const selFunc = $('#r_func');
    if(selFunc){ selFunc.innerHTML = '<option value="">Funcionário (todos)</option>' +
      state.funcionarios.sort((a,b)=>a.nome.localeCompare(b.nome,'pt')).map(f=>`<option value="${f.id}">${f.nome}</option>`).join(''); }

    // popular anos e meses
    const anos = new Set();
    state.ferias.forEach(v=>{
      if(v.inicio) anos.add(new Date(v.inicio).getUTCFullYear());
      if(v.fim) anos.add(new Date(v.fim).getUTCFullYear());
    });
    const selAno = $('#r_ano'); selAno.innerHTML = '<option value="">Ano (todos)</option>' +
      Array.from(anos).sort().map(a=>`<option>${a}</option>`).join('');

    const selMes = $('#r_mes');
    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    selMes.innerHTML = '<option value="">Mês (todos)</option>' + meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');

    renderRelatorio();
  }

  function renderRelatorio(){
    const funcId = $('#r_func')? $('#r_func').value : '';
    const ano = $('#r_ano').value;
    const mes = $('#r_mes').value; // 1..12 ou ''
    const tb = $('#tRelatorio tbody'); tb.innerHTML='';

    const list = state.ferias.map(v=> ({...v, funcionario: state.funcionarios.find(f=>f.id===v.funcionarioId)||{} }))
      .filter(v=> !funcId || v.funcionarioId===funcId)
      .filter(v=> {
        if(!ano && !mes) return true;
        // considera registro se qualquer parte do período cair no filtro
        const i = v.inicio? new Date(v.inicio): null;
        const f = v.fim? new Date(v.fim): null;
        const okAno = !ano || ((i&&i.getUTCFullYear()==ano) || (f&&f.getUTCFullYear()==ano));
        const okMes = !mes || ((i&&(i.getUTCMonth()+1)==mes) || (f&&(f.getUTCMonth()+1)==mes));
        return okAno && okMes;
      });

    let kDias=0, kVencendo=0, kVencidos=0;

    list.forEach(v=>{
      kDias += Number(v.dias||0);
      if(v.vencimento){
        if(inNextDays(v.vencimento,30)) kVencendo++;
        const hoje = new Date(); hoje.setUTCHours(0,0,0,0);
        if(parseDate(v.vencimento) < hoje) kVencidos++;
      }
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${v.funcionario.nome||''}</td>
        <td>${v.funcionario.tipo||''}</td>
        <td>${v.aquisitivo||''}</td>
        <td>${fmtDate(v.inicio)||''}</td>
        <td>${fmtDate(v.fim)||''}</td>
        <td>${v.dias||''}</td>
        <td>${v.status||''}</td>`;
      tb.appendChild(tr);
    });

    $('#kpiRegistros').textContent = list.length;
    $('#kpiDias').textContent = kDias;
    $('#kpiVencendo').textContent = kVencendo;
    $('#kpiVencidos').textContent = kVencidos;

    const anoTxt = ano? `Ano: ${ano}` : 'Todos os anos';
    const mesTxt = mes? ` • Mês: ${$('#r_mes option:checked').textContent}` : '';
    const funcTxt = funcId? ` • Funcionário: ${(state.funcionarios.find(f=>f.id===funcId)||{}).nome||''}` : '';
    $('#tituloRelatorio').textContent = `Relatório de Férias — ${anoTxt}${mesTxt}${funcTxt}`;
  }

  // ======== Handlers: Funcionários ========
  $('#formFuncionario').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = {
      id: $('#f_id').value || uid(),
      nome: $('#f_nome').value.trim(),
      cargo: $('#f_cargo').value.trim(),
      tipo: $('#f_tipo').value,
      admissao: $('#f_admissao').value || null,
      dias_direito: Number($('#f_dias_direito').value||30),
      aquisitivo_ini: $('#f_aquisitivo_ini').value || null,
      aquisitivo_fim: $('#f_aquisitivo_fim').value || null,
      obs: $('#f_obs').value.trim()
    };
    // anti-duplicidade por nome (ignorando maiúsculas/minúsculas e espaços)
    const nomeKey = f.nome.toLowerCase().replace(/\s+/g,' ').trim();
    const dup = state.funcionarios.find(x=> x.id!==f.id && (x.nome||'').toLowerCase().replace(/\s+/g,' ').trim() === nomeKey);
    if(dup){ alert('Já existe um funcionário com este nome. Edite o existente ou use um identificador diferente.'); return; }

    const exists = state.funcionarios.some(x=>x.id===f.id);
    if(exists){ await DB.update('funcionarios', f.id, f); state.funcionarios=await DB.getAll('funcionarios'); }
    else { await DB.push('funcionarios', f); state.funcionarios.push(f); }
    e.target.reset(); $('#f_id').value='';
    $('#formFuncTitle').textContent='Adicionar Funcionário';
    $('#btnFuncionarioCancelarEdicao').classList.add('hide');
    renderFuncionarios(); fillFuncionariosSelect();
  });

  window.editFuncionario = (id)=>{
    const f = state.funcionarios.find(x=>x.id===id); if(!f) return;
    $('#formFuncTitle').textContent='Editar Funcionário';
    $('#f_id').value=f.id; $('#f_nome').value=f.nome||''; $('#f_cargo').value=f.cargo||''; $('#f_tipo').value=f.tipo||'CLT';
    $('#f_admissao').value=f.admissao||''; $('#f_dias_direito').value=f.dias_direito||30;
    $('#f_aquisitivo_ini').value=f.aquisitivo_ini||''; $('#f_aquisitivo_fim').value=f.aquisitivo_fim||''; $('#f_obs').value=f.obs||'';
    $('#btnFuncionarioCancelarEdicao').classList.remove('hide');
  }

  $('#btnFuncionarioCancelarEdicao').addEventListener('click',()=>{
    $('#formFuncionario').reset(); $('#f_id').value='';
    $('#formFuncTitle').textContent='Adicionar Funcionário';
    $('#btnFuncionarioCancelarEdicao').classList.add('hide');
  });

  window.delFuncionario = async (id)=>{
    if(!confirm('Excluir funcionário e todos os registros de férias associados?')) return;
    await DB.remove('funcionarios', id);
    // remove férias associadas
    (await DB.getAll('ferias')).filter(v=>v.funcionarioId===id).forEach(async v=> await DB.remove('ferias', v.id));
    state.funcionarios = await DB.getAll('funcionarios');
    state.ferias = await DB.getAll('ferias');
    renderFuncionarios(); renderFerias(); fillFuncionariosSelect(); renderRelatoriosInit();
  }

  $('#buscaFuncionario').addEventListener('input', renderFuncionarios);

  $('#btnExportarFuncionarios').addEventListener('click', async ()=>{
    const json = Cloud? await Cloud.backup() : Storage.backup();
    const blob = new Blob([json], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_ferias.json'; a.click();
  });

  $('#importFuncFile').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return; const text=await file.text();
    if(Cloud) await Cloud.restore(text); else Storage.restore(text);
    state.funcionarios = await DB.getAll('funcionarios');
    state.ferias = await DB.getAll('ferias');
    renderFuncionarios(); renderFerias(); fillFuncionariosSelect(); renderRelatoriosInit();
  });

  // ======== Handlers: Férias ========
  // cálculo automático de dias
  $('#v_inicio').addEventListener('change', ()=>{ const d=diffDaysInclusive($('#v_inicio').value,$('#v_fim').value); if(d>0) $('#v_dias').value=d; });
  $('#v_fim').addEventListener('change', ()=>{ const d=diffDaysInclusive($('#v_inicio').value,$('#v_fim').value); if(d>0) $('#v_dias').value=d; });

  $('#formFerias').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const v = {
      id: $('#v_id').value || uid(),
      funcionarioId: $('#v_funcionario').value,
      programacao: $('#v_programacao').value || null,
      aquisitivo: $('#v_aquisitivo').value.trim(),
      inicio: $('#v_inicio').value || null,
      fim: $('#v_fim').value || null,
      dias: Number($('#v_dias').value||0),
      vencimento: $('#v_vencimento').value || null,
      status: $('#v_status').value,
      obs: $('#v_obs').value.trim()
    };
    const exists = state.ferias.some(x=>x.id===v.id);
    if(exists){ await DB.update('ferias', v.id, v); state.ferias=await DB.getAll('ferias'); }
    else { await DB.push('ferias', v); state.ferias.push(v); }

    e.target.reset(); $('#v_id').value='';
    $('#formFeriasTitle').textContent='Agendar/Registrar Férias';
    $('#btnFeriasCancelarEdicao').classList.add('hide');
    renderFerias(); renderRelatoriosInit();
  });

  window.editFerias = (id)=>{
    const v = state.ferias.find(x=>x.id===id); if(!v) return;
    $('#formFeriasTitle').textContent='Editar Férias';
    $('#v_id').value=v.id; $('#v_funcionario').value=v.funcionarioId; $('#v_programacao').value=v.programacao||'';
    $('#v_aquisitivo').value=v.aquisitivo||''; $('#v_inicio').value=v.inicio||''; $('#v_fim').value=v.fim||''; $('#v_dias').value=v.dias||'';
    $('#v_vencimento').value=v.vencimento||''; $('#v_status').value=v.status||'Agendado'; $('#v_obs').value=v.obs||'';
    $('#btnFeriasCancelarEdicao').classList.remove('hide');
  }
  $('#btnFeriasCancelarEdicao').addEventListener('click',()=>{
    $('#formFerias').reset(); $('#v_id').value='';
    $('#formFeriasTitle').textContent='Agendar/Registrar Férias';
    $('#btnFeriasCancelarEdicao').classList.add('hide');
  });

  window.delFerias = async (id)=>{
    if(!confirm('Excluir este registro de férias?')) return;
    await DB.remove('ferias', id); state.ferias = await DB.getAll('ferias');
    renderFerias(); renderRelatoriosInit();
  }

  $('#buscaFerias').addEventListener('input', renderFerias);
  $('#filtroStatus').addEventListener('change', renderFerias);

  // ======== Handlers: Relatórios ========
  $('#btnFiltrarRelatorio').addEventListener('click', renderRelatorio);
  $('#btnLimparRelatorio').addEventListener('click', ()=>{ $('#r_func').value=''; $('#r_ano').value=''; $('#r_mes').value=''; renderRelatorio(); });
  $('#btnImprimir').addEventListener('click', ()=> window.print());
  window.reportFuncionario = (id)=>{
    const btn = $$('.tab').find(b=>b.dataset.tab==='relatorios');
    if(btn){ $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
    $$('#funcionarios, #ferias, #relatorios, #config').forEach(s=> s.classList.add('hide'));
    $('#relatorios').classList.remove('hide');
    if($('#r_func')){ $('#r_func').value = id; }
    renderRelatorio();
  }

  // ======== Handlers: Config ========
  $('#btnBackup').addEventListener('click', async ()=>{
    const json = Cloud? await Cloud.backup() : Storage.backup();
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([json],{type:'application/json'})); a.download='backup_ferias.json'; a.click();
  });
  $('#restoreFile').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return; const text=await file.text();
    if(Cloud) await Cloud.restore(text); else Storage.restore(text);
    await loadAll(); alert('Backup restaurado.');
  });
  $('#btnZerarLocal').addEventListener('click', ()=>{ if(confirm('Tem certeza que deseja APAGAR todos os dados locais?')){ localStorage.removeItem('ferias_app_v1'); location.reload(); } });

  $('#btnTestFirebase').addEventListener('click', async ()=>{
    try{ await activateFirebase($('#cfgFirebase').value.trim()||'{}', $('#cfgOrg').value.trim()||'default', $('#cfgAuth').value); alert('Conexão Firebase OK. Clique em Ativar para usar.');}
    catch(e){ console.error(e); alert('Falha ao conectar. Verifique o JSON do firebaseConfig e as regras do Firestore.'); }
  });
  $('#btnAtivarFirebase').addEventListener('click', async ()=>{
    try{
      const cfgStr = $('#cfgFirebase').value.trim()||'{}';
      const org = $('#cfgOrg').value.trim()||'default';
      const auth = $('#cfgAuth').value;
      await activateFirebase(cfgStr, org, auth);
      if(confirm('Deseja enviar os dados atuais para a nuvem?')){
        await Cloud.setAll('funcionarios', state.funcionarios);
        await Cloud.setAll('ferias', state.ferias);
      }
      Storage.setCfg({ cloud:true, firebaseConfig: cfgStr, org, auth });
      await loadAll();
    }catch(e){ alert('Erro ao ativar Firebase.'); }
  });
  $('#btnDesativarFirebase').addEventListener('click', async ()=>{
    if(!confirm('Desativar a nuvem e voltar ao modo local neste dispositivo?')) return;
    Cloud = null;
    const cfg = Storage.getCfg() || {};
    Storage.setCfg({ ...cfg, cloud:false });
    $('#storeStatus').textContent='Local';
    $('#storeStatus').className='pill ok';
    await loadAll();
    alert('Modo local ativado.');
  });

  // ======== Navegação ========
  $$('.tab').forEach(btn=> btn.addEventListener('click', ()=>{
    $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const tab = btn.dataset.tab; $$('#funcionarios, #ferias, #relatorios, #config').forEach(s=> s.classList.add('hide'));
    $('#'+tab).classList.remove('hide');
  }));

  // Init
  (async function(){
    try{
      const cfg = Storage.getCfg();
      if(cfg && cfg.cloud && cfg.firebaseConfig){
        await activateFirebase(cfg.firebaseConfig, cfg.org || 'default', cfg.auth || 'anon');
        // Preenche os campos da tela de Config para facilitar
        $('#cfgFirebase').value = cfg.firebaseConfig;
        $('#cfgOrg').value = cfg.org || 'default';
        $('#cfgAuth').value = cfg.auth || 'anon';
      }
    }catch(e){ console.warn('Falha ao ativar Firebase automaticamente:', e); }
    await loadAll();
  })();
  </script>
</body>
</html>
